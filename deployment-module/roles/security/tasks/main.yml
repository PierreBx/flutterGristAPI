---
# Security role - System hardening and security configuration

- name: Install security packages
  apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
      - apt-listchanges
    state: present
  tags: ['packages']

- name: Configure SSH - Disable root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify: restart sshd
  tags: ['ssh']

- name: Configure SSH - Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  notify: restart sshd
  tags: ['ssh']

- name: Configure SSH - Enable public key authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PubkeyAuthentication'
    line: 'PubkeyAuthentication yes'
    state: present
  notify: restart sshd
  tags: ['ssh']

- name: Configure UFW - Default policies
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }
  tags: ['firewall']

- name: Configure UFW - Allow SSH
  ufw:
    rule: allow
    port: "{{ ssh_port | default('22') }}"
    proto: tcp
  tags: ['firewall']

- name: Configure UFW - Allow HTTP
  ufw:
    rule: allow
    port: '80'
    proto: tcp
  tags: ['firewall', 'web']

- name: Configure UFW - Allow HTTPS
  ufw:
    rule: allow
    port: '443'
    proto: tcp
  tags: ['firewall', 'web']

- name: Enable UFW
  ufw:
    state: enabled
  tags: ['firewall']

- name: Configure fail2ban
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled = true
      port = {{ ssh_port | default('22') }}
      logpath = /var/log/auth.log
  notify: restart fail2ban
  tags: ['fail2ban']

- name: Enable fail2ban service
  systemd:
    name: fail2ban
    enabled: yes
    state: started
  tags: ['fail2ban']

- name: Configure automatic security updates
  copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}";
          "${distro_id}:${distro_codename}-security";
          "${distro_id}ESMApps:${distro_codename}-apps-security";
          "${distro_id}ESM:${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
  tags: ['updates']
