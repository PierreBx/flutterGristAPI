#!/bin/bash
# =============================================================================
# SSL Certificate Expiry Check Script
# =============================================================================
# Checks SSL certificate expiry and warns if expiring soon
#
# Usage: ./check-cert-expiry.sh <domain_name>
#
# Generated by Ansible - DO NOT EDIT MANUALLY
# =============================================================================

set -euo pipefail

DOMAIN="${1:-{{ domain_name }}}"
WARNING_DAYS="{{ ssl_expiry_warning_days }}"
CERT_PATH="/etc/letsencrypt/live/${DOMAIN}/cert.pem"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

if [ ! -f "$CERT_PATH" ]; then
    echo -e "${RED}[ERROR]${NC} Certificate not found: $CERT_PATH"
    exit 1
fi

# Get certificate expiry date
EXPIRY_DATE=$(openssl x509 -enddate -noout -in "$CERT_PATH" | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
CURRENT_EPOCH=$(date +%s)
DAYS_UNTIL_EXPIRY=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))

echo "SSL Certificate Status for: $DOMAIN"
echo "========================================"
echo "Expiry Date: $EXPIRY_DATE"
echo "Days until expiry: $DAYS_UNTIL_EXPIRY"
echo ""

if [ $DAYS_UNTIL_EXPIRY -lt 0 ]; then
    echo -e "${RED}[CRITICAL]${NC} Certificate has EXPIRED!"
    echo "Run: sudo certbot renew --force-renewal"
    exit 2
elif [ $DAYS_UNTIL_EXPIRY -lt $WARNING_DAYS ]; then
    echo -e "${YELLOW}[WARNING]${NC} Certificate expiring in $DAYS_UNTIL_EXPIRY days!"
    echo "Consider renewing: sudo certbot renew"
    exit 1
else
    echo -e "${GREEN}[OK]${NC} Certificate is valid"
    exit 0
fi
