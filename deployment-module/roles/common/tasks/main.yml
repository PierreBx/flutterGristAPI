---
# Common role - Base system configuration tasks

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: ['packages']

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  tags: ['packages', 'upgrade']

- name: Install essential packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - git
      - vim
      - htop
      - net-tools
      - wget
      - unzip
      - build-essential
      - python3
      - python3-pip
      - python3-venv
    state: present
  tags: ['packages']

- name: Set timezone
  timezone:
    name: "{{ server_timezone | default('UTC') }}"
  tags: ['system']

- name: Set locale
  locale_gen:
    name: "{{ server_locale | default('en_US.UTF-8') }}"
    state: present
  tags: ['system']

- name: Create swap file (if not exists)
  command: |
    dd if=/dev/zero of=/swapfile bs=1M count=2048
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
  args:
    creates: /swapfile
  tags: ['system', 'swap']

- name: Add swap to fstab
  lineinfile:
    path: /etc/fstab
    line: '/swapfile none swap sw 0 0'
    state: present
  tags: ['system', 'swap']

- name: Configure sysctl settings
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'vm.swappiness', value: '10' }
    - { key: 'vm.vfs_cache_pressure', value: '50' }
    - { key: 'net.ipv4.tcp_keepalive_time', value: '600' }
  tags: ['system', 'tuning']

- name: Enable and start cron service
  systemd:
    name: cron
    enabled: yes
    state: started
  tags: ['services']
