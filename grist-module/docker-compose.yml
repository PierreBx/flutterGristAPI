version: '3.8'

services:
  # Grist service - self-hosted spreadsheet database
  grist:
    image: gristlabs/grist:latest
    container_name: grist_server
    ports:
      - "8484:8484"
    volumes:
      - ./grist-data:/persist
    environment:
      - GRIST_SESSION_SECRET=${GRIST_SESSION_SECRET:-your-secret-key-here}
      - GRIST_SINGLE_ORG=docs
      - APP_HOME_URL=${GRIST_APP_HOME_URL:-http://localhost:8484}
      - GRIST_SANDBOX_FLAVOR=unsandboxed
    restart: unless-stopped
    networks:
      - grist-network

  flutter-test:
    build:
      context: ../flutter-module
      dockerfile: ../grist-module/Dockerfile
    container_name: flutter_grist_widgets_test
    volumes:
      - ../flutter-module:/app
      - flutter-pub-cache:/root/.pub-cache
    environment:
      - FLUTTER_ROOT=/opt/flutter
    command: flutter test --reporter expanded
    networks:
      - grist-network

  flutter-analyze:
    build:
      context: ../flutter-module
      dockerfile: ../grist-module/Dockerfile
    container_name: flutter_grist_widgets_analyze
    volumes:
      - ../flutter-module:/app
      - flutter-pub-cache:/root/.pub-cache
    environment:
      - FLUTTER_ROOT=/opt/flutter
    command: flutter analyze
    networks:
      - grist-network

  flutter-shell:
    build:
      context: ../flutter-module
      dockerfile: ../grist-module/Dockerfile
    container_name: flutter_grist_widgets_shell
    volumes:
      - ../flutter-module:/app
      - flutter-pub-cache:/root/.pub-cache
    environment:
      - FLUTTER_ROOT=/opt/flutter
    command: /bin/bash
    stdin_open: true
    tty: true
    networks:
      - grist-network

volumes:
  flutter-pub-cache:

networks:
  grist-network:
    driver: bridge
